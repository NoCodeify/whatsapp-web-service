name: ğŸš€ Deploy WhatsApp Web Service

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - prod

env:
  PROJECT_ID: whatzaidev
  REGION: europe-central2
  REPOSITORY: whatsapp-repo
  SERVICE_NAME: whatsapp-web-service

jobs:
  test:
    name: ğŸ§ª Test & Lint
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ“¥ Install dependencies
      run: npm ci

    - name: ğŸ” Lint code
      run: npx prettier --check .

    - name: ğŸ—ï¸ Build TypeScript
      run: npm run build

    - name: ğŸ§ª Run tests
      run: npm test

  build-and-deploy-dev:
    name: ğŸš€ Deploy to Development
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment: development

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: ğŸ› ï¸ Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: ğŸ”§ Configure Docker for Artifact Registry
      run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

    - name: ğŸ—ï¸ Build and deploy with Cloud Build
      run: |
        ENV_SUFFIX=${{ github.event.inputs.environment == 'prod' && '' || '-dev' }}
        SERVICE_NAME="${{ env.SERVICE_NAME }}${ENV_SUFFIX}"

        gcloud builds submit \
          --config cloudbuild-dev.yaml \
          --substitutions=_SERVICE_NAME=${SERVICE_NAME},_REGION=${{ env.REGION }}

    - name: ğŸ” Verify deployment
      run: |
        ENV_SUFFIX=${{ github.event.inputs.environment == 'prod' && '' || '-dev' }}
        SERVICE_NAME="${{ env.SERVICE_NAME }}${ENV_SUFFIX}"

        # Get service URL
        SERVICE_URL=$(gcloud run services describe ${SERVICE_NAME} \
          --region=${{ env.REGION }} \
          --format='value(status.url)')

        echo "ğŸŒ Service deployed at: ${SERVICE_URL}"

        # Health check
        curl -f "${SERVICE_URL}/health" || exit 1
        echo "âœ… Health check passed!"

  build-and-deploy-prod:
    name: ğŸš€ Deploy to Production
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'
    environment: production

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: ğŸ› ï¸ Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: ğŸ”§ Configure Docker for Artifact Registry
      run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

    - name: ğŸ—ï¸ Build and deploy to production
      run: |
        gcloud builds submit \
          --config cloudbuild.yaml \
          --substitutions=_SERVICE_NAME=${{ env.SERVICE_NAME }},_REGION=${{ env.REGION }}

    - name: ğŸ” Verify production deployment
      run: |
        # Get service URL
        SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
          --region=${{ env.REGION }} \
          --format='value(status.url)')

        echo "ğŸŒ Production service deployed at: ${SERVICE_URL}"

        # Health check
        curl -f "${SERVICE_URL}/health" || exit 1
        echo "âœ… Production health check passed!"

    - name: ğŸ“Š Update production URL secret
      run: |
        SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
          --region=${{ env.REGION }} \
          --format='value(status.url)')

        echo -n "${SERVICE_URL}" | gcloud secrets versions add WHATSAPP_WEB_SERVICE_URL --data-file=-

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ“¥ Install dependencies
      run: npm ci

    - name: ğŸ” Run security audit
      run: npm audit --audit-level moderate

    - name: ğŸ”’ Run CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: typescript

    - name: ğŸ”’ Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3